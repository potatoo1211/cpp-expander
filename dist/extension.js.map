{"version":3,"file":"extension.js","mappings":"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","sources":["webpack://cpp-expander/./src/extension.ts","webpack://cpp-expander/external commonjs \"vscode\"","webpack://cpp-expander/external node-commonjs \"fs\"","webpack://cpp-expander/external node-commonjs \"path\"","webpack://cpp-expander/webpack/bootstrap","webpack://cpp-expander/webpack/startup"],"sourcesContent":["import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\n// 実行中のタスク管理\nlet currentExecution: vscode.TaskExecution | undefined;\n// ログ出力用のチャンネル\nlet outputChannel: vscode.OutputChannel;\n\nexport function activate(context: vscode.ExtensionContext) {\n    // ログチャンネルの作成\n    outputChannel = vscode.window.createOutputChannel(\"C++ Expander Log\");\n\n    let justRun = vscode.commands.registerCommand('cpp-expander.justRun', async () => {\n        await handleWorkflow({ copyAfterRun: false });\n    });\n\n    let runAndCopy = vscode.commands.registerCommand('cpp-expander.runAndCopy', async () => {\n        await handleWorkflow({ copyAfterRun: true });\n    });\n\n    context.subscriptions.push(justRun);\n    context.subscriptions.push(runAndCopy);\n    context.subscriptions.push(outputChannel);\n}\n\nexport function deactivate() {\n    if (outputChannel) {\n        outputChannel.dispose();\n    }\n}\n\n// ---------------------------------------------------------\n// メイン処理ワークフロー\n// ---------------------------------------------------------\nasync function handleWorkflow(options: { copyAfterRun: boolean }) {\n    const editor = vscode.window.activeTextEditor;\n    if (!editor) return;\n\n    // 1. 保存\n    if (editor.document.isDirty) {\n        await editor.document.save();\n    }\n    const filePath = editor.document.fileName;\n\n    // ログ初期化\n    outputChannel.clear();\n    outputChannel.appendLine(`[Start] Processing: ${filePath}`);\n\n    // 2. 前回のタスク停止\n    if (currentExecution) {\n        try { currentExecution.terminate(); } catch (e) { }\n        currentExecution = undefined;\n    }\n\n    // 3. タスク実行設定\n    const commandLine = `ulimit -s unlimited && g++ -std=c++20 -O2 -I. \"${filePath}\" && ./a.out; RET=$?; echo \"\"; echo \"Press Enter to close...\"; read dummy; exit $RET`;\n    const task = new vscode.Task(\n        { type: 'cpp-expander', task: 'run' },\n        vscode.TaskScope.Workspace,\n        'Run C++',\n        'cpp-expander',\n        new vscode.ShellExecution(commandLine)\n    );\n\n    task.presentationOptions = {\n        reveal: vscode.TaskRevealKind.Always,\n        focus: true,\n        panel: vscode.TaskPanelKind.Shared,\n        clear: true,\n        showReuseMessage: false\n    };\n\n    // 4. タスク終了後の処理\n    const onDidEndTaskProcess = vscode.tasks.onDidEndTaskProcess(async (e) => {\n        if (e.execution === currentExecution) {\n            onDidEndTaskProcess.dispose();\n            currentExecution = undefined;\n\n            // 正常終了(exitCode === 0) かつ コピーモードの場合\n            if (e.exitCode === 0 && options.copyAfterRun) {\n                try {\n                    const workspaceFolder = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath;\n                    \n                    // 展開処理を実行\n                    const expandedCode = expandIncludes(filePath, workspaceFolder);\n                    \n                    await vscode.env.clipboard.writeText(expandedCode);\n                    \n                    vscode.window.showInformationMessage('Finished & Copied!');\n                    outputChannel.appendLine(`[Success] Copied to clipboard.`);\n                } catch (err: any) {\n                    vscode.window.showErrorMessage(`Expand Error: ${err.message}`);\n                    outputChannel.appendLine(`[Error] ${err.message}`);\n                }\n            } else if (e.exitCode !== 0) {\n                outputChannel.appendLine(`[Info] Exit code ${e.exitCode}. Copy skipped.`);\n            }\n        }\n    });\n\n    currentExecution = await vscode.tasks.executeTask(task);\n}\n\n// ---------------------------------------------------------\n// インクルード展開ロジック\n// ---------------------------------------------------------\nfunction expandIncludes(entryFilePath: string, workspaceRoot?: string): string {\n    const visited = new Set<string>();\n\n    function processFile(currentPath: string, isMainFile: boolean): string {\n        if (!isMainFile) {\n            if (visited.has(currentPath)) return \"\";\n            visited.add(currentPath);\n        }\n\n        if (!fs.existsSync(currentPath)) {\n            throw new Error(`File not found: ${currentPath}`);\n        }\n\n        const content = fs.readFileSync(currentPath, 'utf-8');\n        const currentDir = path.dirname(currentPath);\n\n        // 正規表現: #include \"...\"\n        const regex = /^\\s*#include\\s*\"([^\"]+)\".*$/gm;\n\n        return content.replace(regex, (match, relPath) => {\n            // パス解決\n            let targetPath = path.resolve(currentDir, relPath);\n            let found = fs.existsSync(targetPath);\n\n            if (!found && workspaceRoot) {\n                const rootPath = path.resolve(workspaceRoot, relPath);\n                if (fs.existsSync(rootPath)) {\n                    targetPath = rootPath;\n                    found = true;\n                }\n            }\n\n            if (found) {\n                outputChannel.appendLine(`  Expand: \"${relPath}\" -> ${targetPath}`);\n                \n                const expandedContent = processFile(targetPath, false);\n\n                // ★修正ポイント: matchに含まれる可能性のある改行コード(\\rや\\n)を完全に除去\n                // これにより \"// #include ... <改行>\" となる事故を防ぎます\n                const safeMatch = match.replace(/[\\r\\n]+/g, '');\n\n                return `// ${safeMatch}\\n${expandedContent}`;\n\n            } else {\n                outputChannel.appendLine(`  [Skip] Not found: \"${relPath}\"`);\n                return match; \n            }\n        });\n    }\n\n    return processFile(entryFilePath, true);\n}","module.exports = require(\"vscode\");","module.exports = require(\"fs\");","module.exports = require(\"path\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(265);\n"],"names":["context","outputChannel","vscode","window","createOutputChannel","justRun","commands","registerCommand","async","handleWorkflow","copyAfterRun","runAndCopy","subscriptions","push","dispose","currentExecution","options","editor","activeTextEditor","document","isDirty","save","filePath","fileName","clear","appendLine","terminate","e","undefined","commandLine","task","Task","type","TaskScope","Workspace","ShellExecution","presentationOptions","reveal","TaskRevealKind","Always","focus","panel","TaskPanelKind","Shared","showReuseMessage","onDidEndTaskProcess","tasks","execution","exitCode","workspaceFolder","workspace","workspaceFolders","uri","fsPath","expandedCode","entryFilePath","workspaceRoot","visited","Set","processFile","currentPath","isMainFile","has","add","fs","existsSync","Error","content","readFileSync","currentDir","path","dirname","replace","match","relPath","targetPath","resolve","found","rootPath","expandedContent","expandIncludes","env","clipboard","writeText","showInformationMessage","err","showErrorMessage","message","executeTask","module","exports","require","__webpack_module_cache__","__webpack_exports__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","call"],"ignoreList":[],"sourceRoot":""}